name: Deploy API
on:
  workflow_call:
    inputs:
      api_name:
        description: 'Name of the API (e.g., sendgrid-api)'
        required: true
        type: string
      port:
        description: 'Port number for the API container'
        required: true
        type: string
      image_name:
        description: 'Container image name (defaults to repository name)'
        required: false
        type: string
        default: ''
    secrets:
      DEPLOY_HOST:
        description: 'Server hostname or IP address'
        required: true
      DEPLOY_USER:
        description: 'SSH username for deployment'
        required: true
      DEPLOY_SSH_KEY:
        description: 'Private SSH key for deployment'
        required: true
      GITHUB_TOKEN:
        description: 'GitHub token for container registry'
        required: true

env:
  REGISTRY: ghcr.io

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags for image)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-{{ref}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            API_NAME="${{ inputs.api_name }}"
            PORT="${{ inputs.port }}"
            IMAGE_TAG="${{ steps.meta.outputs.tags }}"
            REPO_NAME="${{ github.repository }}"
            IMAGE_FULL_NAME="${{ env.REGISTRY }}/${REPO_NAME}:${IMAGE_TAG}"
            DEPLOY_DIR="/home/${{ secrets.DEPLOY_USER }}/api_center/${API_NAME}"
            LOG_DIR="/home/${{ secrets.DEPLOY_USER }}/logs/api_center/${API_NAME}"

            echo "Deploying API: ${API_NAME} with image ${IMAGE_FULL_NAME} on port ${PORT}"
            echo "Deployment directory: ${DEPLOY_DIR}"
            echo "Log directory: ${LOG_DIR}"

            # Create deployment and log directories if they don't exist
            mkdir -p "${DEPLOY_DIR}"
            mkdir -p "${LOG_DIR}"

            # Ensure Docker network exists
            docker network inspect api-network >/dev/null 2>&1 || \
              docker network create api-network

            # Pull the latest image
            echo "Pulling Docker image: ${IMAGE_FULL_NAME}"
            docker pull "${IMAGE_FULL_NAME}"

            # Create or update docker-compose.prod.yml
            cat <<EOFDOCKER > "${DEPLOY_DIR}/docker-compose.prod.yml"
            version: '3.8'
            services:
              ${API_NAME}:
                image: ${IMAGE_FULL_NAME}
                container_name: ${API_NAME}
                restart: unless-stopped
                networks:
                  - api-network
                ports:
                  - "${PORT}:3000"
                env_file:
                  - .env
                volumes:
                  - ${LOG_DIR}:/app/logs
                healthcheck:
                  test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s

            networks:
              api-network:
                external: true
EOFDOCKER

            # Deploy with Docker Compose
            echo "Deploying with Docker Compose..."
            cd "${DEPLOY_DIR}"
            docker-compose -f docker-compose.prod.yml up -d --remove-orphans

            echo "Deployment complete for ${API_NAME}."
            echo "Waiting for container health check..."
            timeout 120s bash -c \
              'while [ "$(docker inspect -f {{.State.Health.Status}} ${{ inputs.api_name }})" != "healthy" ]; do \
                 sleep 5; \
               done' || echo "Container ${{ inputs.api_name }} did not become healthy in time."

            echo "Container status:"
            docker ps -f name=${API_NAME}
